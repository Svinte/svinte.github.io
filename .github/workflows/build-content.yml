name: Build & Deploy Content

on:
  workflow_run:
    workflows: ["Translate content"]
    types:
      - completed

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build-only

      - name: Create 404.html fallback
        run: cp dist/index.html dist/404.html

      - name: Wait until no Pages deployment is in progress
        run: |
          echo "Waiting for any ongoing Pages deployment to finish..."
          while true; do
            deployment_id=$(gh api repos/${GITHUB_REPOSITORY}/pages/deployment --jq '.[0].id' 2>/dev/null || echo "")
            if [ -z "$deployment_id" ]; then
              echo "No deployment found. Proceeding..."
              break
            fi
            status=$(gh api repos/${GITHUB_REPOSITORY}/pages/deployment/$deployment_id --jq '.status')
            if [[ "$status" == "in_progress" || "$status" == "building" ]]; then
              echo "Deployment $deployment_id status: $status. Waiting 15s..."
              sleep 15
            else
              echo "Deployment $deployment_id completed. Proceeding..."
              break
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
